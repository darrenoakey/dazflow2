#!/opt/homebrew/bin/python3.13
import argparse
import os
import subprocess
import sys
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent
TEST_OUT = PROJECT_ROOT / "output" / "testing"


# ##################################################################
# run command
# executes a shell command and returns the exit code
def run_cmd(cmd: list[str]) -> int:
    return subprocess.call(cmd, cwd=PROJECT_ROOT)


# ##################################################################
# start command
# starts the fastapi server with uvicorn with hot reload enabled
def command_start(args: argparse.Namespace) -> int:
    # Determine port and data_dir (defaults match uvicorn startup)
    port = args.port if args.port else 31415
    data_dir = args.data_dir if args.data_dir else "."

    # Set environment variables so config picks them up on import
    os.environ["DAZFLOW_PORT"] = str(port)
    os.environ["DAZFLOW_DATA_DIR"] = data_dir

    os.chdir(PROJECT_ROOT)
    port_str = str(port)
    os.execv(
        sys.executable,
        [sys.executable, "-m", "uvicorn",
         "src.api:app",
         "--host", "0.0.0.0",
         "--port", port_str,
         "--reload",
         "--reload-include", "*.html",
         "--reload-include", "*.css",
         "--reload-include", "*.js"]
    )


# ##################################################################
# test command
# runs a specific test target
def command_test(args: argparse.Namespace) -> int:
    TEST_OUT.mkdir(parents=True, exist_ok=True)
    target = args.target
    log = TEST_OUT / (target.replace("/", "_").replace("::", "_") + ".log")
    result = run_cmd([
        sys.executable, "-m", "pytest",
        "-q", target,
        "--maxfail=1",
        "--disable-warnings",
    ])
    print(f"Test output: {log}")
    return result


# ##################################################################
# lint command
# runs ruff linter
def command_lint(_: argparse.Namespace) -> int:
    return run_cmd([
        sys.executable, "-m", "ruff",
        "check",
        "--line-length", "120",
        "src/",
    ])


# ##################################################################
# check command
# runs full test suite and quality gates on src directory
def command_check(_: argparse.Namespace) -> int:
    return run_cmd(["dazpycheck", "--pattern", "src/"])


# ##################################################################
# ai command
# natural language interface to the workflow system
def command_ai(args: argparse.Namespace) -> int:
    import asyncio

    # Combine all words into the input string
    input_str = " ".join(args.words) if args.words else ""

    if not input_str:
        print("Usage: ./run ai <command or prompt>")
        print("")
        print("Simple commands:")
        print("  list              List all workflows")
        print("  enable <name>     Enable a workflow")
        print("  disable <name>    Disable a workflow")
        print("  run <name>        Run/execute a workflow")
        print("  status            Server status")
        print("  tags              List tags")
        print("  groups            List concurrency groups")
        print("  folders           List folders")
        print("")
        print("Or use natural language:")
        print("  ./run ai create a workflow that does x y z")
        print("  ./run ai move all news workflows to a news folder")
        return 1

    # Set up environment
    data_dir = args.data_dir if args.data_dir else "."
    os.environ["DAZFLOW_DATA_DIR"] = data_dir

    # Import and run
    sys.path.insert(0, str(PROJECT_ROOT))
    from src.ai_brain import process_input

    result = asyncio.run(process_input(input_str))
    print(result)
    return 0


# ##################################################################
# workflow-test command
# runs workflow tests (execute workflows and assert against results)
def command_workflow_test(args: argparse.Namespace) -> int:
    # Set up environment
    data_dir = args.data_dir if args.data_dir else "."
    os.environ["DAZFLOW_DATA_DIR"] = data_dir

    # Import and run
    sys.path.insert(0, str(PROJECT_ROOT))
    from src.workflow_testing import (
        discover_test_workflows,
        format_suite_result,
        format_test_result,
        run_workflow_test_sync,
        run_test_suite_sync,
    )

    if args.workflow:
        # Run specific workflow test
        result = run_workflow_test_sync(args.workflow)
        print(format_test_result(result))
        return 0 if result.passed else 1
    else:
        # Discover and run all tests
        test_files = discover_test_workflows(args.test_dir)
        if not test_files:
            print(f"No test workflows found in workflows/{args.test_dir}/")
            print("Test workflows should be named *_test.json or test_*.json")
            return 0

        suite = run_test_suite_sync(test_files, args.test_dir)
        print(format_suite_result(suite))
        return 0 if suite.all_passed else 1


# ##################################################################
# main
# parse arguments and dispatch to the appropriate command
def main(argv: list[str]) -> int:
    parser = argparse.ArgumentParser(description="dazflow2 project runner")
    sub = parser.add_subparsers(dest="cmd", required=True)

    p_start = sub.add_parser("start", help="Start server with hot reload")
    p_start.add_argument("--port", type=int, help="Port to listen on (default 31415)")
    p_start.add_argument("--data-dir", type=str, help="Data directory (default .)")
    p_start.set_defaults(func=command_start)

    p_test = sub.add_parser("test", help="Run a single test target")
    p_test.add_argument("target", help="e.g. src/api_test.py::test_health")
    p_test.set_defaults(func=command_test)

    p_lint = sub.add_parser("lint", help="Run linter")
    p_lint.set_defaults(func=command_lint)

    p_check = sub.add_parser("check", help="Run full suite and gates")
    p_check.set_defaults(func=command_check)

    p_ai = sub.add_parser("ai", help="AI interface to workflow system")
    p_ai.add_argument("words", nargs="*", help="Command or natural language prompt")
    p_ai.add_argument("--data-dir", type=str, help="Data directory (default .)")
    p_ai.set_defaults(func=command_ai)

    p_wf_test = sub.add_parser("workflow-test", help="Run workflow tests")
    p_wf_test.add_argument("workflow", nargs="?", help="Specific workflow test to run (e.g., tests/my_test.json)")
    p_wf_test.add_argument("--test-dir", type=str, default="tests", help="Directory to discover tests (default: tests)")
    p_wf_test.add_argument("--data-dir", type=str, help="Data directory (default .)")
    p_wf_test.set_defaults(func=command_workflow_test)

    args = parser.parse_args(argv)
    return args.func(args)


# ##################################################################
# standard dispatch
if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
